{% extends "base.html" %}

{% block title %}Find Group Orders - MealMates{% endblock %}

{% block content %}
<div class="find-orders-container">
    <h2 class="page-title">Available Group Orders</h2>

    {% if orders %}
        <ul class="order-list">
            {% for order in orders %}
                <li class="order-item">
                    <h3>{{ order.restaurant.name }}</h3>
                    <p><strong>Created by:</strong> {{ order.creator.username }}</p>
                    <p><strong>Address:</strong> {{ order.restaurant.address }}</p>
                    <p><strong>Deadline:</strong> {{ order.deadline.strftime('%Y-%m-%d %H:%M') }}</p>

                    <!-- Preview ETA Button -->
                    <form method="POST" action="{{ url_for('preview_eta', school_id=order.creator.username) }}">
                        <button type="submit" class="secondary-button">Check ETA to My Address</button>
                    </form>

                    <!-- Show Route Details Button -->
                    <button class="secondary-button" onclick="showRouteDetails('{{ order.creator.username }}')">
                        Show Route Steps
                    </button>
                    <ul id="route-{{ order.creator.username }}" class="route-result"></ul>

                    <!-- Show Route Map Button -->
                    <button class="secondary-button" onclick="showRouteMap('{{ order.creator.username }}')">
                        Show Route on Map
                    </button>
                    <div id="map-link-{{ order.creator.username }}"></div>

                    <!-- Join Button -->
                    <a href="{{ url_for('join_order', order_id=order.id) }}" class="primary-button" style="margin-top: 10px;">
                        Join This Order
                    </a>
                    <button onclick="loadRadar('{{ order.creator.username }}')">Compare My Similarity</button>
                    <div id="radar-container-{{ order.creator.username }}" style="height:400px;"></div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No open group orders at the moment.</p>
    {% endif %}
</div>

<script>
function showRouteDetails(schoolId) {
    fetch(`/route_with/${schoolId}`, { method: "POST" })
        .then(res => res.json())
        .then(data => {
            console.log("Route data:", data);

            const container = document.getElementById(`route-${schoolId}`);
            container.innerHTML = "";
            const route = data.seq || data.route;
            if (Array.isArray(route) && route.length) {
                route.forEach(([user, eta]) => {
                    const li = document.createElement("li");
                    li.innerText = `${user}: ETA ${eta} min`;
                    container.appendChild(li);
                });
            } else {
                container.innerHTML = "<li>Route info not available.</li>";
            }
        })
        .catch(err => {
            console.error("Route fetch error:", err);
        });
}

function showRouteMap(schoolId) {
    fetch(`/route_with/${schoolId}`, { method: "POST" })
        .then(res => res.json())
        .then(data => {
            const div = document.getElementById(`map-link-${schoolId}`);
            if (data.map_url) {
                div.innerHTML = `<a href="${data.map_url}" target="_blank">View Route Map</a>`;
            } else {
                div.innerHTML = "<p>Map not available.</p>";
            }
        })
        .catch(err => {
            console.error("Map link fetch error:", err);
        });
}
</script>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
function loadRadar(schoolId) {
    const containerId = `radar-container-${schoolId}`;
    fetch(`/api/similarity_radar/${schoolId}`)
        .then(res => res.json())
        .then(data => {
            Plotly.newPlot(containerId, data.data, data.layout);
        })
        .catch(err => {
            document.getElementById(containerId).innerText = "Failed to load similarity chart.";
            console.error("Radar fetch error:", err);
        });
}
</script>
{% endblock %}